<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selvo Labs Chat</title>
    <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
    <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
</head>
<body>
   
<df-messenger
  id="dfMessenger"
  location="us-central1"
  project-id="virtual-agent-training-476115"
  agent-id="80f40701-01b6-4ef3-b50c-c7209d4a5c04"
  language-code="en"
  max-query-length="-1">
  <df-messenger-chat-bubble
    chat-title="Selvo Labs Bot">
  </df-messenger-chat-bubble>
</df-messenger>

<style>
  df-messenger {
    z-index: 999;
    position: fixed;
    --df-messenger-font-color: #000;
    --df-messenger-font-family: Google Sans;
    --df-messenger-chat-background: #f3f6fc;
    --df-messenger-message-user-background: #d3e3fd;
    --df-messenger-message-bot-background: #fff;
    bottom: 16px;
    right: 16px;
  }
</style>

<script>
// Method 1: Using DF Messenger events
document.addEventListener('DOMContentLoaded', function() {
    const dfMessenger = document.querySelector('df-messenger');
    
    // Listen for when DF Messenger is ready
    dfMessenger.addEventListener('df-messenger-loaded', function() {
        console.log('DF Messenger loaded');
        
        // Get the internal chat element
        const chat = dfMessenger.shadowRoot.querySelector('df-messenger-chat');
        
        if (chat) {
            // Observe when chat becomes visible/opened
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes') {
                        const isOpen = chat.hasAttribute('opened');
                        if (isOpen) {
                            console.log('Chat opened!');
                            // Trigger welcome message
                            triggerWelcomeMessage();
                        }
                    }
                });
            });
            
            observer.observe(chat, {
                attributes: true,
                attributeFilter: ['opened']
            });
        }
    });
});

// Method 2: Simpler approach - trigger welcome on first interaction
let welcomeSent = false;

document.addEventListener('click', function(event) {
    const dfMessenger = document.querySelector('df-messenger');
    
    if (dfMessenger && dfMessenger.contains(event.target) && !welcomeSent) {
        setTimeout(() => {
            triggerWelcomeMessage();
            welcomeSent = true;
        }, 1000);
    }
});

// Method 3: Direct API call to trigger welcome intent
function triggerWelcomeMessage() {
    const dfMessenger = document.querySelector('df-messenger');
    
    if (dfMessenger && dfMessenger.shadowRoot) {
        // Access the internal chat component
        const chat = dfMessenger.shadowRoot.querySelector('df-messenger-chat');
        
        if (chat) {
            // Use the internal method to send a welcome event
            try {
                // Method 3a: Try to use Dialogflow's REST API directly
                sendWelcomeViaAPI();
            } catch (error) {
                console.log('Error triggering welcome:', error);
                // Method 3b: Fallback - simulate user sending "hi"
                simulateUserMessage();
            }
        }
    }
}

// Direct API call method
function sendWelcomeViaAPI() {
    // You'll need to use the Dialogflow Sessions API
    // This requires setting up CORS and authentication
    console.log('This method requires backend setup');
}

// Fallback: Simulate user sending a message
function simulateUserMessage() {
    const dfMessenger = document.querySelector('df-messenger');
    
    if (dfMessenger && dfMessenger.shadowRoot) {
        // Find the input field and send button
        const input = dfMessenger.shadowRoot.querySelector('input');
        const sendButton = dfMessenger.shadowRoot.querySelector('button[aria-label="Send"]');
        
        if (input && sendButton) {
            input.value = 'hi';
            
            // Create and dispatch events to simulate user interaction
            const inputEvent = new Event('input', { bubbles: true });
            input.dispatchEvent(inputEvent);
            
            setTimeout(() => {
                sendButton.click();
            }, 100);
        }
    }
}

// Method 4: Most reliable - Use Dialogflow Messenger's built-in features
// Add this attribute to automatically show first message
setTimeout(() => {
    const dfMessenger = document.querySelector('df-messenger');
    if (dfMessenger) {
        // This will make the chat start with a welcome message
        dfMessenger.setAttribute('intent', 'WELCOME');
    }
}, 2000);

</script>

</body>
</html>